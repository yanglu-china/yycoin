<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="PayOrderDaoImpl">

    <resultMap id="PayOrder" class="com.china.center.oa.finance.vo.PayOrderVO">
        <result property="billNo" column="billNo" />
        <result property="billType" column="billType" />
        <result property="billTypeDesc" column="billTypeDesc" />
        <result property="billDate" column="billDate" />
        <result property="billStatus" column="billStatus" />
        <result property="payeeBank" column="payeeBank" />
        <result property="payeeBankAccName" column="payeeBankAccName" />
        <result property="payeeBankAcc" column="payeeBankAcc" />
        <result property="payeeAmount" column="payeeAmount" />
        <result property="logTime" column="logTime" />
        <result property="description" column="description" />
        <result property="cityId" column="cityid" />
        <result property="cityName" column="cityname" />
    </resultMap>
    
    <resultMap id="PayOrderListLogVO" class="com.china.center.oa.finance.vo.PayOrderListLogVO">
        <result property="id" column="id" />
        <result property="outid" column="outid" />
        <result property="type" column="type" />
        <result property="bankName" column="bankName" />
        <result property="userName" column="userName" />
        <result property="bankNo" column="bankNo" />
        <result property="money" column="money" />
        <result property="province" column="province" />
        <result property="city" column="city" />
        <result property="description" column="description" />
        <result property="outidtime" column="outidtime" />
        <result property="status" column="status" />
        <result property="outbillid" column="outbillid" />
        <result property="operator" column="operator" />
        <result property="paytime" column="paytime" />
        <result property="payaccount" column="payaccount" />
        <result property="paybank" column="paybank" />
        <result property="bankstatus" column="bankstatus" />
        <result property="bankpaytime" column="bankpaytime" />
    </resultMap>

	<!-- 销售产品预占的,主要是显示库存页面需要 -->
	<select id="queryPayOrderList" parameterClass="java.util.Map" resultMap="PayOrder">
        select * from (
        SELECT a.*,b.name as cityname FROM (
		SELECT id AS billno,'1' AS billtype ,'采购付款' AS billtypedesc,paydate AS billdate ,'1' AS billstatus,logtime,description,
		custaccountbank AS payeebank,custaccountname AS payeeBankAccName,custaccount AS payeeBankAcc,realmoneys/100 AS payeeAmount,cityid FROM t_center_stockpayapply WHERE STATUS=3) 
		a LEFT JOIN	t_center_city  b ON a.cityid=b.id
		UNION
		SELECT a.*,b.name as cityname FROM (
		SELECT id AS billno,'2' AS billtype ,'采购预付款' AS billtypedesc,paydate AS billdate ,'1' AS billstatus,logtime,description,
		custaccountbank AS payeebank,custaccountname AS payeeBankAccName,custaccount AS payeeBankAcc,realmoneys/100 AS payeeAmount,cityid FROM t_center_stockpreapply WHERE STATUS=3) 
		a LEFT JOIN t_center_city  b ON a.cityid=b.id
		UNION
		SELECT a.id AS billNo,'3' AS billtype,'借款申请付款' AS billtypedesc,a.begindate AS billdate,'1' AS billstatus,a.logtime,a.description,
		b.bankName AS  payeebank,b.userName AS payeeBankAccName,b.bankNo AS payeeBankAcc,b.cmoneys/100 AS payeeAmount,'' AS cityid,'' as cityname
		FROM t_center_travelapply a ,T_CENTER_TRAVELAPPLYPAY b WHERE a.id=b.parentId
		AND a.status=22 AND a.type NOT IN (8,10,15,22)
		UNION
		SELECT a.id AS billNo,'4' AS billtype,'报销申请付款' AS billtypedesc,a.begindate AS billdate,'1' AS billstatus,a.logtime,a.description,
		b.bankName AS  payeebank,b.userName AS payeeBankAccName,b.bankNo AS payeeBankAcc,b.cmoneys/100  AS payeeAmount,'' AS cityid,'' as cityname
		FROM t_center_tcpexpense a ,T_CENTER_TRAVELAPPLYPAY b WHERE a.id=b.parentId
		AND a.status=22 AND a.type NOT IN (8,10,15,22) AND cmoneys>0
		UNION 
		SELECT a.APPLYID AS billNo,'5' AS billtype,'预收退款' AS billtypedesc,a.logtime AS billdate,'1' AS billstatus,a.logtime,a.description,
		b.bankname AS  payeebank,b.customername AS payeeBankAccName,b.customeraccount AS payeeBankAcc,a.checktotal/100  AS payeeAmount,b.bankcity as cityname,'' as cityid
		FROM T_CENTER_TCPAPPROVE a ,T_CENTER_BACKPREPAY_APPLY b
		WHERE a.TYPE=23 AND a.STATUS=29 and a.checktotal>0 and b.id=a.applyid) aaa where aaa.payeeAmount>0
		<dynamic prepend=""> 
            <isNotEmpty prepend="and" property="payOrderNo"> 
                    aaa.billNo= #payOrderNo#
            </isNotEmpty> 
            <isNotEmpty prepend="and" property="payeeBank"> 
                    aaa.payeebank like concat('%',#payeeBank#,'%')
            </isNotEmpty> 
            <isNotEmpty prepend="and" property="payeeAccName"> 
                    aaa.payeeBankAccName like concat('%',#payeeAccName#,'%')
            </isNotEmpty> 
            
            <isNotEmpty prepend="and" property="payeeAcc"> 
                    aaa.payeeBankAcc=#payeeAcc#
            </isNotEmpty>
            <isNotEmpty prepend="and" property="payeeAmount"> 
                    aaa.payeeAmount=$payeeAmount$
            </isNotEmpty>
            <isNotEmpty prepend="and" property="billTime"> 
                    aaa.billdate=#billTime#
            </isNotEmpty>
       </dynamic>
       order by billdate desc
		
    </select>
    
    <select id="queryPayOrderList41" parameterClass="java.util.Map" resultMap="PayOrder">
    	SELECT a.*,b.name as cityname FROM (
		SELECT id AS billno,'1' AS billtype ,'采购付款' AS billtypedesc,paydate AS billdate ,'1' AS billstatus,logtime,description,
		custaccountbank AS payeebank,custaccountname AS payeeBankAccName,custaccount AS payeeBankAcc,realmoneys/100 AS payeeAmount,cityid FROM t_center_stockpayapply 
		WHERE STATUS=3  and realmoneys>0) a LEFT JOIN	t_center_city  b ON a.cityid=b.id
		<dynamic prepend="where"> 
            <isNotEmpty prepend="and" property="payOrderNo"> 
                    a.billno= #payOrderNo#
            </isNotEmpty> 
            <isNotEmpty prepend="and" property="payeeBank"> 
                    a.payeebank like concat('%',#payeeBank#,'%')
            </isNotEmpty> 
            <isNotEmpty prepend="and" property="payeeAccName"> 
                    a.payeeBankAccName like concat('%',#payeeAccName#,'%')
            </isNotEmpty> 
            <isNotEmpty prepend="and" property="payeeAcc"> 
                    a.payeeBankAcc=#payeeAcc#
            </isNotEmpty>
            <isNotEmpty prepend="and" property="payeeAmount"> 
                    a.payeeAmount=$payeeAmount$
            </isNotEmpty>
            <isNotEmpty prepend="and" property="billTime"> 
                    a.billdate=#billTime#
            </isNotEmpty>
       </dynamic> 
       order by billdate desc
    </select>
    
    <select id="queryPayOrderList42" parameterClass="java.util.Map" resultMap="PayOrder">
    	SELECT a.*,b.name as cityname FROM (
		SELECT id AS billno,'2' AS billtype ,'采购预付款' AS billtypedesc,paydate AS billdate ,'1' AS billstatus,logtime,description,
		custaccountbank AS payeebank,custaccountname AS payeeBankAccName,custaccount AS payeeBankAcc,realmoneys/100 AS payeeAmount,cityid FROM t_center_stockpreapply 
		WHERE STATUS=3  and realmoneys>0) a LEFT JOIN t_center_city  b ON a.cityid=b.id
		<dynamic prepend="where"> 
            <isNotEmpty prepend="and" property="payOrderNo"> 
                    a.billno= #payOrderNo#
            </isNotEmpty> 
            <isNotEmpty prepend="and" property="payeeBank"> 
                    a.payeebank like concat('%',#payeeBank#,'%')
            </isNotEmpty> 
            <isNotEmpty prepend="and" property="payeeAccName"> 
                    a.payeeBankAccName like concat('%',#payeeAccName#,'%')
            </isNotEmpty> 
            <isNotEmpty prepend="and" property="payeeAcc"> 
                    a.payeeBankAcc=#payeeAcc#
            </isNotEmpty>
            <isNotEmpty prepend="and" property="payeeAmount"> 
                    a.payeeAmount=$payeeAmount$
            </isNotEmpty>
            <isNotEmpty prepend="and" property="billTime"> 
                    a.billdate=#billTime#
            </isNotEmpty>
        </dynamic> 
        order by billdate desc
    </select>
    
    <select id="queryPayOrderList43" parameterClass="java.util.Map" resultMap="PayOrder">
    	SELECT a.id AS billNo,'3' AS billtype,'借款申请付款' AS billtypedesc,a.begindate AS billdate,'1' AS billstatus,a.logtime,a.description,
		b.bankName AS payeebank,b.userName AS payeeBankAccName,b.bankNo AS payeeBankAcc,b.cmoneys/100 AS payeeAmount,b.bankcity as cityname,'' as cityid
		FROM t_center_travelapply a ,T_CENTER_TRAVELAPPLYPAY b WHERE a.id=b.parentId
		AND a.status=22 AND a.type NOT IN (8,10,15,22) and cmoneys>0
		<dynamic prepend=""> 
            <isNotEmpty prepend="and" property="payOrderNo"> 
                    a.id= #payOrderNo#
            </isNotEmpty> 
            <isNotEmpty prepend="and" property="payeeBank"> 
                    b.bankName like concat('%',#payeeBank#,'%')
            </isNotEmpty> 
            <isNotEmpty prepend="and" property="payeeAccName"> 
                    b.userName like concat('%',#payeeAccName#,'%')
            </isNotEmpty> 
            <isNotEmpty prepend="and" property="payeeAcc"> 
                    b.bankNo=#payeeAcc#
            </isNotEmpty>
            <isNotEmpty prepend="and" property="payeeAmount"> 
                    (b.cmoneys/100)=$payeeAmount$
            </isNotEmpty>
            <isNotEmpty prepend="and" property="billTime"> 
                    a.begindate=#billTime#
            </isNotEmpty>
         </dynamic>
         order by billdate desc
    </select>
    
    <select id="queryPayOrderList44" parameterClass="java.util.Map" resultMap="PayOrder">
    	SELECT a.id AS billNo,'4' AS billtype,'报销申请付款' AS billtypedesc,a.begindate AS billdate,'1' AS billstatus,a.logtime,a.description,
		b.bankName AS  payeebank,b.userName AS payeeBankAccName,b.bankNo AS payeeBankAcc,b.cmoneys/100  AS payeeAmount,b.bankcity as cityname,'' as cityid
		FROM t_center_tcpexpense a ,T_CENTER_TRAVELAPPLYPAY b WHERE a.id=b.parentId
		AND a.status=22 AND a.type NOT IN (8,10,15,22) AND cmoneys>0
		<dynamic prepend=""> 
            <isNotEmpty prepend="and" property="payOrderNo"> 
                    a.id= #payOrderNo#
            </isNotEmpty> 
            <isNotEmpty prepend="and" property="payeeBank"> 
                    b.bankName like concat('%',#payeeBank#,'%')
            </isNotEmpty> 
            <isNotEmpty prepend="and" property="payeeAccName"> 
                    b.userName like concat('%',#payeeAccName#,'%')
            </isNotEmpty> 
            <isNotEmpty prepend="and" property="payeeAcc"> 
                    b.bankNo=#payeeAcc#
            </isNotEmpty>
            <isNotEmpty prepend="and" property="payeeAmount"> 
                    (b.cmoneys/100)=$payeeAmount$
            </isNotEmpty>
            <isNotEmpty prepend="and" property="billTime"> 
                    a.begindate=#billTime#
            </isNotEmpty>
        </dynamic>
        order by billdate desc
    </select>
    
    <select id="queryPayOrderList45" parameterClass="java.util.Map" resultMap="PayOrder">
    	SELECT a.APPLYID AS billNo,'5' AS billtype,'预收退款' AS billtypedesc,a.logtime AS billdate,'1' AS billstatus,a.logtime,a.description,
		b.bankname AS  payeebank,b.customername AS payeeBankAccName,b.customeraccount AS payeeBankAcc,a.checktotal/100  AS payeeAmount,b.bankcity as cityname,'' as cityid
		FROM T_CENTER_TCPAPPROVE a ,T_CENTER_BACKPREPAY_APPLY b
		WHERE a.TYPE=23 AND a.STATUS=29 and a.checktotal>0 and b.id=a.applyid
		<dynamic prepend=""> 
            <isNotEmpty prepend="and" property="payOrderNo"> 
                    a.APPLYID= #payOrderNo#
            </isNotEmpty> 
            <isNotEmpty prepend="and" property="payeeBank"> 
                    1=1
            </isNotEmpty> 
            <isNotEmpty prepend="and" property="payeeAccName"> 
                    1=1
            </isNotEmpty> 
            <isNotEmpty prepend="and" property="payeeAcc"> 
                    1=1
            </isNotEmpty>
            <isNotEmpty prepend="and" property="payeeAmount"> 
                   (a.checktotal/100)=$payeeAmount$
            </isNotEmpty>
            <isNotEmpty prepend="and" property="billTime"> 
                    a.logtime=#billTime#
            </isNotEmpty>
       </dynamic> 
       order by billdate desc
    </select>
    
    <select id="queryPayOrderLogList" parameterClass="java.util.Map" resultMap="PayOrderListLogVO">
    	select * from t_center_paylistlog where 1=1 
    	<dynamic prepend=""> 
            <isNotEmpty prepend="and" property="payOrderStatus"> 
                    status= #payOrderStatus#
            </isNotEmpty> 
            <isNotEmpty prepend="and" property="payeeBank"> 
                    bankname like concat('%',#payeeBank#,'%')
            </isNotEmpty> 
            <isNotEmpty prepend="and" property="payeeAccName"> 
                    username like concat('%',#payeeAccName#,'%')
            </isNotEmpty> 
            <isNotEmpty prepend="and" property="payeeAcc"> 
                    bankno=#payeeAcc#
            </isNotEmpty>
            <isNotEmpty prepend="and" property="payeeAmount"> 
                    money=$payeeAmount$
            </isNotEmpty>
            <isNotEmpty prepend="and" property="billTime"> 
                    DATE_FORMAT(outidtime,'%Y-%m-%d')=#billTime#
            </isNotEmpty>
            <isNotEmpty prepend="and" property="payOrderNo"> 
                    outid=#payOrderNo#
            </isNotEmpty>
            <isNotEmpty prepend="and" property="payOrderType"> 
                    type=#payOrderType#
            </isNotEmpty>
       </dynamic> 
    </select>
    
    <insert id="createPayListLog" parameterClass="com.china.center.oa.finance.vo.PayOrderListLogVO">
    	insert into t_center_paylistlog (id,outid,type,bankname,username, bankno,money,province,city,description,outidtime,status,
    	outbillid,operator,paytime,payaccount,paybank,bankstatus,bankpaytime) 
    	values 
    	(#id#,#outid#,#type#,#bankName#,#userName#,#bankNo#,#money#,#province#,#city#,#description#,#outidtime#,#status#,
    	#outbillid#,#operator#,#paytime#,#payaccount#,#paybank#,#bankstatus#,#bankpaytime#)
    </insert>
    
    <select id="queryPayOrderLogStatusList" resultMap="PayOrderListLogVO">
    	select * from t_center_paylistlog where status=2
    </select>
    
    <update id="updatePayOrderLog" parameterClass="java.util.Map">
    	update t_center_paylistlog set status=#status#,bankstatus=#bankStatus#,bankpaytime=sysdate() where outid=#outId# and status=2
    </update>
</sqlMap>
